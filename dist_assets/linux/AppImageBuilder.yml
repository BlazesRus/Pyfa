version: 1

AppDir:
  path: ./AppDir

  app_info:
    id: pyfa
    name: pyfa
    icon: pyfa
    version: $PYFA_VERSION
    exec: ${APPDIR}/bin/python3.11
    exec_args: "-s ${APPDIR}/opt/pyfa/pyfa.py $@"

  apt:
    arch: [ amd64 ]
    sources:
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb https://ppa.launchpadcontent.net/deadsnakes/ppa/ubuntu jammy main'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0xf23c5a6cf475977595c89f51ba6932366a755776'

    include:
      - python3.11
    exclude: []

  runtime:
    env:
      PYTHONHOME: '${APPDIR}/usr'
      PYTHONPATH: '${APPDIR}/usr/lib/python3.11/site-packages'

  after_runtime:
    # Install python dependencies
    - python3.11 -s -m pip install --prefix=/usr --root=AppDir -U pip setuptools wheel
    - python3.11 -s -m pip install --prefix=/usr --root=AppDir -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04 -r requirements.txt
    # Compile app data
    - find locale/ -type f -name "*.po" -exec msgen "{}" -o "{}" \;
    - python3.11 scripts/compile_lang.py
    - python3.11 scripts/dump_crowdin_progress.py
    - python3.11 db_update.py
    # Calculate app version
    - export PYFA_VERSION="$(python3.11 scripts/dump_version.py)"
    # Copy app and clean it up
    - mkdir -p AppDir/usr/src
    - cp -r eos graphs gui imgs locale service utils eve.db config.py pyfa.py db_update.py README.md LICENSE version.yml AppDir/usr/src
    - find AppDir/usr/src | grep -E "(__pycache__|\.pyc|\.pyo$)" | xargs rm -rf

AppImage:
  sign-key: None
  arch: x86_64
