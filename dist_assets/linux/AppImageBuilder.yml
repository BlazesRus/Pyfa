version: 1

script:
  - rm -rf AppDir  | true
  - mkdir -p AppDir/usr/src
  # wxpython dependencies to host
  - sudo apt install libnotify4 libsdl2-2.0-0
  # Install wx (needed by crowdin script) and sqlalchemy/logbook (needed by db update script)
  - grep -iE 'wxpython|sqlalchemy|logbook' requirements.txt | xargs python3 -B -s -m pip install --user -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04
  # Compile app data
  - find locale/ -type f -name "*.po" -exec msgen "{}" -o "{}" \;
  - python3 -B scripts/compile_lang.py
  - python3 -B scripts/dump_crowdin_progress.py
  - python3 -B db_update.py
  - export PYFA_VERSION="$(python3 -B scripts/dump_version.py)"
  # Copy data over to app dir
  - cp -r eos graphs gui imgs locale service utils eve.db config.py pyfa.py db_update.py README.md LICENSE version.yml AppDir/usr/src
  - cp imgs/gui/pyfa64.png AppDir/usr/share/icons

AppDir:
  path: ./AppDir

  app_info:
    id: pyfa
    name: pyfa
    icon: pyfa64
    version: $PYFA_VERSION
    exec: usr/bin/python3.11
    exec_args: "-s $APPDIR/opt/pyfa/pyfa.py $@"

  apt:
    arch: [ amd64 ]
    sources:
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920d1991bc93c'
    - sourceline: 'deb https://ppa.launchpadcontent.net/deadsnakes/ppa/ubuntu jammy main'
      key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0xf23c5a6cf475977595c89f51ba6932366a755776'

    include:
      - python3.11
      - libnotify4
    exclude: []

  after_bundle:
    # Install python dependencies to bundled interpreter
    - export PYTHONHOME="AppDir/usr"
    - export PYTHONPATH="AppDir/usr/lib/python3.11/site-packages"
    - python3.11 -s -m pip install -U pip setuptools wheel
    - python3.11 -s -m pip install -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04 -r requirements.txt

  runtime:
    env:
      PYTHONHOME: '${APPDIR}/usr'
      PYTHONPATH: '${APPDIR}/usr/lib/python3.11/site-packages'

AppImage:
  sign-key: None
  arch: x86_64
